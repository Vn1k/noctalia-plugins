import QtQuick
import Quickshell
import Quickshell.Io
import qs.Commons
import qs.Services.UI

Item {
    id: root
    property var pluginApi: null

    readonly property string configBase: Quickshell.env("XDG_CONFIG_HOME") || (Quickshell.env("HOME") + "/.config")
    readonly property string configDir: configBase + "/niri"
    readonly property string mainConfig: configDir + "/config.kdl"
    readonly property string layoutConfig: configDir + "/layout.kdl"

    function setMode(modeName) {
        if (!root.pluginApi) return

        var targetMode = modeName.toLowerCase()
        var centerVal = "always"
        var label = "Center Mode"

        if (targetMode === "split") {
            centerVal = "never"
            label = "Split Mode"
        } 

        // 1. Update File Config Niri
        var fileContent = `// Auto-generated by Niri Layout Switcher\nlayout {\n    center-focused-column "${centerVal}"\n}`
        var cmd = `printf '${fileContent}' > "${root.layoutConfig}" && niri msg action reload-config-file`
        
        layoutProcess.command = ["bash", "-c", cmd]
        layoutProcess.running = true

        // 2. Update Settings (for ui)
        root.pluginApi.pluginSettings.mode = targetMode
        root.pluginApi.saveSettings()
        
        ToastService.showNotice("Layout: " + label)
    }

    readonly property string installScript: `
        DIR="${root.configDir}"
        MAIN="${root.mainConfig}"
        LAYOUT="${root.layoutConfig}"
        mkdir -p "$DIR"
        if [ ! -f "$LAYOUT" ]; then
            echo '// Auto-generated by Plugin' > "$LAYOUT"
            echo 'layout { center-focused-column "always"; }' >> "$LAYOUT"
        fi
        if ! grep -q 'include "layout.kdl"' "$MAIN"; then
            cp "$MAIN" "$MAIN.bak"
            echo '' >> "$MAIN"
            echo '// Auto-added by Niri Layout Switcher Plugin' >> "$MAIN"
            echo 'include "layout.kdl"' >> "$MAIN"
            echo "CHANGED"
        fi
    `

    Component.onCompleted: setupProcess.running = true

    Process {
        id: setupProcess
        command: ["bash", "-c", root.installScript]
        stdout: SplitParser {
            onRead: (data) => {
                if (data.trim() === "CHANGED") {
                    reloadProcess.running = true
                    ToastService.showNotice("Plugin installed & Layout injected.")
                }
            }
        }
    }
    
    Process { id: reloadProcess; command: ["niri", "msg", "action", "reload-config-file"] }
    Process { id: layoutProcess }

    IpcHandler {
        target: "niri-layout-mode"

        function toggle() {
             var current = root.pluginApi ? (root.pluginApi.pluginSettings.mode || "center") : "center"
             var nextMode = (current === "center" ? "split" : "center")
             
             root.setMode(nextMode)
        }
    }
}